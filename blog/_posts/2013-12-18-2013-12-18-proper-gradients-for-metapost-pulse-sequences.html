---
layout: post
title: Proper Gradients for MetaPost Pulse Sequences
categories:
- LaTeX
- Linux
- PhD
- Programming
- Tinker
tags:
- academia
- Gentoo
- imaging
- MRI
- research
- science
- software
- technology
- thesis
- topslider
status: publish
type: post
published: true
meta:
  _thumbnail_id: '495'
---
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<p><em>In which I improve upon the previous post...</em></p>
<p>In <a href="/blog/2013/12/17/pulse-sequence-diagrams-using-metapost">yesterday's post</a> I talked about using <a target="_blank" href="http://foundry.supelec.fr/gf/project/metapost/">MetaPost</a> to generate Pulse Sequence Diagrams for MRI documents. I have been using this to make nice diagrams for my Thesis. There is one problem, however, with the <a target="_blank" href="http://en.wikipedia.org/wiki/Pulse_sequence">pulse sequence</a> file provided on <a target="_blank" href="http://www.celos.net/comp/pulses/">Mark's website</a> - it generates square gradients.</p>
<p>Theoretically speaking a perfect MR sequence would use square gradients to generate a signal but this isn't practical in reality. Instead gradients are ramped over time, dependent on the limitations of the scanner, leading to trapezoidal gradient shapes.* [1]</p>
<p>By adding these the following code to <a target="_blank" href="http://www.celos.net/comp/pulses/pulses.mp">pulses.mp</a>. Under drawing functions:</p>
<pre data-preserve-html-node="true"><code data-preserve-html-node="true" class="language-latex">def gradf(expr off, xs, ys) =
    draw ((0,0)--(0.25u,1u)--(0.75u,1u)--(1u,0)) xscaled xs yscaled ys shifted off; 
enddef;</code></pre>
<p>Under progressive functions:</p>
<pre data-preserve-html-node="true"><code data-preserve-html-node="true" class="language-latex">def xgrad(expr l, h) =
    gradf((Ox,Oy),l,h);
    Ox := Ox + l*u; 
enddef;</code></pre>
<p id="yui_3_17_2_1_1436996827544_48565">If you call xgrad in your MetaPost file it will now draw a trapezoidal gradient. The ramping will always be a quarter of the length of the gradient which you may find isn't suitable for longer gradients. In that case some simple edits to these functions will be necessary.</p>
<p>Here's an example sequence using the new gradients:</p>
<img src="http://lh6.googleusercontent.com/-HSztmv95HIw/UrHP5m7MlXI/AAAAAAAAAz8/Sc0U6EqmZgc/w1140-h881-no/se_grads.png" title="" alt=""><p>&lt;EDIT&gt;</p>
<p>The same thing can be achieved for the frequency encoding block.</p>
<p>Under drawing functions:</p>
<pre data-preserve-html-node="true"><code data-preserve-html-node="true" class="language-latex">def tablegrf(expr off, xs, ys, gran, upd) =
    begingroup; 
    for i=-gran upto gran: 
        draw ((0,0)--(0.25u,1u)--(0.75u,1u)--(1u,0)) xscaled xs yscaled (ys*(i/gran)) shifted off withcolor 0.5white withpen pencircle scaled 0.5pt; 
    endfor; 
    endgroup; 
    gradf(off,xs,-upd*ys); drawarrow ((0.5u*xs,-0.9u*ys*upd)+off)--((0.5u*xs,0.9u*ys*upd)+off) withpen pencircle scaled 2pt withcolor 0.3white;
enddef;</code></pre>
<p>Under progressive functions:</p>
<pre data-preserve-html-node="true"><code data-preserve-html-node="true" class="language-latex">def xtablegr(expr l, h, grad, upd) =
    tablegrf((Ox,Oy),l,h,grad,upd);
    Ox := Ox + l*u; 
enddef;</code></pre>
<p id="yui_3_17_2_1_1436996827544_53173">Which will give you a nice version of that too:</p>
<img src="http://lh6.googleusercontent.com/-pWAgfVprTUY/UrHUqtlcpSI/AAAAAAAAA0U/6kttxxCOI9s/w1140-h881-no/se_grads.png" title="" alt=""><p>&lt;/EDIT&gt;</p>
<p>*Many other gradient shapes can be used to achieve other ends. For example, <a target="_blank" href="http://spin.ecn.purdue.edu/fmri/PDFLibrary/HennelF_MRM_1999_42_6_10.pdf">quieting the sequence noise</a>.</p>
<p>Tom Out!</p>
<p>P.S. Now a Major Github repository! <a target="_blank" href="https://github.com/tawilkinson/pulses">https://github.com/tawilkinson/pulses</a></p>
<h3>References</h3>
<p>[1] Bernstein, M. A., et al. (2004) <em>Handbook of MRI Pulse Sequences</em>. Academic Press.</p>
</body></html>
